<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Investor's Dashboard</title>
  <link rel="stylesheet" href="/investor.css" />
  <style>
@import url(https://fonts.googleapis.com/css?family=Lato:400,700);
    *,
    *:before,
    *:after {
      box-sizing: border-box;
    }
    .container {
      width: calc(100% - 40px);
      background-color: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: auto;
      padding: 20px;
      box-sizing: border-box;
    }
    .people-list {
      width: 260px;
      float: left;
    }
    .people-list ul {
      list-style-type: none;
    }
    .people-list input {
      border-radius: 3px;
      border: none;
      padding: 14px;
      color: white;
      background: #6a6c75;
      width: 90%;
      font-size: 14px;
    }
    .people-list ul li {
      padding-bottom: 20px;
    }
    .people-list .about {
      float: left;
      margin-top: 8px;
      padding-left: 8px;
    }
    .chat {
      width: 490px;
      float: left;
      background: #f2f5f8;
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
      color: #434651;
    }
    .chat .chat-header {
      padding: 20px;
      border-bottom: 2px solid white;
    }
    .chat .chat-header .chat-about {
      float: left;
      padding-left: 10px;
      margin-top: 6px;
    }
    .chat .chat-header .chat-with {
      font-weight: bold;
      font-size: 16px;
    }
    .chat .chat-header .chat-num-messages {
      color: #92959e;
    }
    .chat .chat-header .fa-star {
      float: right;
      color: #d8dadf;
      font-size: 20px;
      margin-top: 12px;
    }
    .chat .chat-history {
      padding: 30px 30px 20px;
      border-bottom: 2px solid white;
      overflow-y: scroll;
      height: 575px;
    }
    .chat .chat-history .message-data {
      margin-bottom: 15px;
    }
    .chat .chat-history .message-data-time {
      color: #a8aab1;
      padding-left: 6px;
    }
    .chat .chat-history .message {
      color: white;
      padding: 18px 20px;
      line-height: 26px;
      font-size: 16px;
      border-radius: 7px;
      margin-bottom: 30px;
      width: 90%;
      position: relative;
    }
    .chat .chat-history .message:after {
      bottom: 100%;
      left: 7%;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
      border-bottom-color: #86bb71;
      border-width: 10px;
      margin-left: -10px;
    }
    .chat .chat-history .my-message {
      background: #86bb71;
      float: right;
      text-align: right;
    }
    .chat .chat-history .my-message:after {
      border-bottom-color: #86bb71;
      left: auto;
      right: 7%;
    }
    .chat .chat-history .other-message {
      background: #94c2ed;
      float: left;
      text-align: left;
    }
    .chat .chat-history .other-message:after {
      border-bottom-color: #94c2ed;
      left: 7%;
    }
    .chat .chat-message {
      padding: 30px;
    }
    .chat .chat-message textarea {
      width: 100%;
      border: none;
      padding: 10px 20px;
      font: 14px/22px "Lato", Arial, sans-serif;
      margin-bottom: 10px;
      border-radius: 5px;
      resize: none;
    }
    .chat .chat-message .fa-file-o,
    .chat .chat-message .fa-file-image-o {
      font-size: 16px;
      color: gray;
      cursor: pointer;
    }
    .chat .chat-message button {
      float: right;
      color: #94c2ed;
      font-size: 16px;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: #f2f5f8;
    }
    .chat .chat-message button:hover {
      color: #75b1e8;
    }
    .me {
      color: #94c2ed;
    }
    .align-left {
      text-align: left;
    }
    .align-right {
      text-align: right;
    }
    .float-right {
      float: right;
    }
    .clearfix:after {
      visibility: hidden;
      display: block;
      font-size: 0;
      content: " ";
      clear: both;
      height: 0;
    }
  </style>
</head>
<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  <aside
      class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4"
      id="sidenav-main"
    >
      <div class="sidenav-header">
        <i
          class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true"
          id="iconSidenav"
        ></i>
        <a class="navbar-brand m-0" href="#" target="_blank">
          <span class="ms-1 font-weight-bold">Investor Dashboard</span>
        </a>
      </div>
      <hr class="horizontal dark mt-0" />
      <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/investorDash">
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/farmersList">
              <span class="nav-link-text ms-1">Farmers</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/investmentopp">
              <span class="nav-link-text ms-1">Investment Opportunities</span>
            </a>
          </li>
          <li class="nav-item mt-3">
            <h6
              class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6"
            >
              Account pages
            </h6>
          </li>
          {{! <li class="nav-item">
            <a class="nav-link" href="/profile">
              <span class="nav-link-text ms-1">Profile</span>
            </a>
          </li> }}
          <li class="nav-item">
            <a class="nav-link" href="/chat">
              <span class="nav-link-text ms-1">Chat</span>
            </a>
          </li>
        </ul>
      </div>
    </aside>

  <main class="main-content position-relative border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px=0 mx-4 shadow-none border-radius-xl" id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <h5 class="font-weight-bolder text-white mb-0">TERIMBERE</h5>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center"></div>
          <ul class="navbar-nav justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="/signout" class="nav-link text-white font-weight-bold px-0">
                <i class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none">Sign Out</span>
              </a>
            </li>
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->

    <!-- Chat Section -->
    <div class="container clearfix">
      <div class="people-list" id="people-list">
        <ul class="list" id="chat-users-list">
          <!-- Dynamically added chat users will appear here -->
        </ul>
      </div>

      <div class="chat">
        <div class="chat-header clearfix">
          <div class="chat-about">
            <div class="chat-with">Chat with <span id="chat-with-name"></span></div>
            <div class="chat-num-messages">already <span id="chat-num-messages"></span> messages</div>
          </div>
          <i class="fa fa-star"></i>
        </div>
        <!-- end chat-header -->

        <div class="chat-history">
          <ul id="chat-history-list">
            <!-- Dynamically added messages will appear here -->
          </ul>
        </div>
        <!-- end chat-history -->

        <div class="chat-message clearfix">
          <textarea name="message-to-send" id="message-to-send" placeholder="Type your message" rows="3"></textarea>
          <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp;
          <i class="fa fa-file-image-o"></i>
          <button id="send-message-button">Send</button>
        </div>
        <!-- end chat-message -->
      </div>
      <!-- end chat -->
    </div>
    <!-- end container -->
  </main>

  <!-- Core JS Files -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function() {
      let currentChatUserPhone = null;

      function fetchChatUsers() {
        $.get('/api/chat-users', function(users) {
          const chatUsersList = $('#chat-users-list');
          chatUsersList.empty();
          users.forEach(user => {
            const userItem = `
              <li class="clearfix chat-user-item" data-phone="${user.phone}">
                <div class="about">
                  <div class="name">${user.name}</div>
                </div>
              </li>
            `;
            chatUsersList.append(userItem);
          });

          $('.chat-user-item').click(function() {
            const userPhone = $(this).data('phone');
            currentChatUserPhone = userPhone;
            fetchChatHistory(userPhone);
            $('#chat-with-name').text($(this).find('.name').text());
          });
        });
      }

      function fetchChatHistory(userPhone) {
        $.get(`/api/chat-history/${userPhone}`, function(messages) {
          const chatHistoryList = $('#chat-history-list');
          chatHistoryList.empty();
          messages.forEach(message => {
            const messageItem = `
              <li class="clearfix">
                <div class="message-data ${message.sender === 'me' ? 'align-right' : ''}">
                  <span class="message-data-time">${new Date(message.timestamp).toLocaleTimeString()}, Today</span>
                  &nbsp; &nbsp;
                  <span class="message-data-name">${message.sender === 'me' ? 'Me' : message.sender}</span>
                  <i class="fa fa-circle ${message.sender === 'me' ? 'me' : 'online'}"></i>
                </div>
                <div class="message ${message.sender === 'me' ? 'my-message' : 'other-message'} float-${message.sender === 'me' ? 'right' : 'left'}">
                  ${message.content}
                </div>
              </li>
            `;
            chatHistoryList.append(messageItem);
          });
          $('#chat-num-messages').text(messages.length);
        });
      }

      fetchChatUsers();

      $('#send-message-button').click(function() {
        const messageContent = $('#message-to-send').val();
        if (messageContent.trim() !== '') {
          const message = {
            content: messageContent
          };
          if (currentChatUserPhone) {
            $.post(`/api/send-message/${currentChatUserPhone}`, message, function(newMessage) {
              fetchChatHistory(currentChatUserPhone);
            });
          }
        }
      });

      function pollMessages() {
        if (currentChatUserPhone) {
          fetchChatHistory(currentChatUserPhone);
        }
      }

      // Poll every 5 seconds
      setInterval(pollMessages, 5000);
    });
  </script>
</body>
</html>
